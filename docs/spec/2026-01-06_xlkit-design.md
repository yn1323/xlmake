# xlkit 設計骨子

## 1. コンセプト・差別化

### なぜ xlkit を作るのか
既存のJS/TypeScript向けExcel出力ライブラリ（ExcelJS等）は**命令的**であり、最終的なアウトプットがコードから見えづらい。

xlkitは**宣言的**なAPIを提供し、コードを見れば最終的なExcelの構造がわかる形を目指す。

| 観点 | ExcelJS（命令的） | xlkit（宣言的） |
|------|------------------|----------------|
| 書き方 | セルを1つずつ操作 | 最終形を宣言 |
| 見通し | コードから結果が見えづらい | コードから結果が見える |
| 例え | jQuery | React |

### 差別化ポイント
- **宣言的API**: 最終アウトプットがわかりやすい形で書ける
- **メソッドチェーン型**: 流れるようにExcelを構築できる
- **TypeScript完全対応**: 型補完が効いて書きやすい

## 2. ターゲット・スコープ

### ターゲット・設計思想
| 項目 | 決定 |
|------|------|
| ターゲット | 自分用 + OSSとして本気で公開 |
| 設計思想 | バランス型（基本シンプル、必要なら拡張可能） |
| 動作環境 | Node.js + ブラウザ両対応 |
| ライブラリ名 | xlkit（確定） |
| ライセンス | MIT |
| 公開先 | npm |

### メインユースケース
- **データエクスポート**がメイン
- **表 + ちょっとテキスト**（タイトル、説明文など）にも対応
- 細かい帳票レベルのレイアウトは**対象外**

### 想定データ量
- 基本は小規模（〜1,000行）を想定
- シンプルな表形式なら大規模（10万行〜）もストリーミングで対応

## 3. v1.0 機能スコープ

### 3.1 Excel生成機能
| 機能 | 対応 | 備考 |
|------|------|------|
| テーブル出力（ヘッダー + データ行 + スタイル + マージ） | ✅ | |
| 複数シート対応 | ✅ | 必須機能 |
| 画像挿入 | ✅ | |
| 大規模データ対応（ストリーミング） | ✅ | 10万行以上に対応 |
| チャート | ❌ | スコープ外 |
| 数式サポート | ❌ | スコープ外。計算はプログラム側で行う |
| 既存Excelへの追記 | ❌ | スコープ外。常に新規作成 |

### 3.2 Excel読み取り機能
| 項目 | 内容 |
|------|------|
| 主な用途 | xlkitの結合テストで生成ファイルの検証 |
| 副次的な用途 | ライブラリ利用者に委ねる |

**読み取り対象:**
- セルの値 ✅
- セルのスタイル（フォント、色、罫線など） ✅
- マージ情報 ✅
- シート名 ✅
- 列幅・行高 ❌（対象外）

### 3.3 デモ
| 項目 | 内容 |
|------|------|
| フロントエンド | シンプルなサンプル集（React + Vite）。複数のサンプルをボタンでExcelダウンロード |
| バックエンド | examples/にNode.jsサンプルコード配置。開発者がローカルで実行可能 |

## 4. 非機能要件

### 4.1 スタイリング
- **プリセット**: よく使うスタイル（罫線、ヘッダー色など）をプリセットで簡単に適用
- **カスタマイズ**: 必要ならフォント、色、罫線など細かく指定も可能
- **両方対応**: プリセットで簡単に + 必要なら細かく指定

### 4.2 エラーハンドリング
| 状況 | 対応 |
|------|------|
| デフォルト値で動ける場合 | デフォルト値で続行 |
| 何も起きない/意味がない状態になる場合 | `throw Error` |

**方針**: 致命的なものは例外、軽微なものはデフォルト値で続行

### 4.3 パフォーマンス
- 基本は小規模（〜1,000行）を想定
- シンプルな表形式なら大規模（10万行〜）もストリーミングで対応
- ExcelJSのストリーミングAPI（`stream.xlsx.WorkbookWriter`）を活用

## 5. API設計方針

### 設計思想
| 項目 | 決定 |
|------|------|
| 設計思想 | バランス型（基本シンプル、必要なら拡張可能） |
| API形式 | **メソッドチェーン型** |

### APIイメージ（あくまでもイメージ。詳細はあとで決める）
```typescript
// 基本的な使い方
xlkit()
  .title("月次売上レポート")
  .columns([
    { key: "name", label: "商品名" },
    { key: "price", label: "価格" },
    { key: "quantity", label: "数量" },
  ])
  .data(salesData)
  .style({ header: { bold: true, fill: "#4472C4" } })
  .save("report.xlsx")

// 複数シート
xlkit()
  .sheet("売上")
    .title("売上データ")
    .columns([...])
    .data(salesData)
  .sheet("在庫")
    .title("在庫データ")
    .columns([...])
    .data(stockData)
  .save("report.xlsx")
```

### 宣言的APIのメリット
- コードを見れば最終的なExcelの構造がわかる
- TypeScriptの補完が効く
- 設定を変更しやすい

## 6. 技術スタック

| 項目 | 選定 | 理由 |
|------|------|------|
| 言語 | TypeScript | 型安全、補完が効く |
| 依存 | ExcelJS | 実績あり、Node.js + ブラウザ両対応 |
| ビルド | tsup | ESM+CJS両対応、設定簡単 |
| リンター | Biome.js | 高速、設定シンプル |
| テスト | Vitest | 高速、Viteと相性良い |
| デモ | React + Vite | 型安全、エコシステム充実 |

## 7. プロジェクト構成

### モノレポ構成
- **モノレポ構成**: ライブラリ本体 + デモサイトを同一リポジトリで管理
- **パッケージマネージャ**: pnpm
- **ワークスペース**: pnpm workspace

### ドキュメント
- **v1.0**: READMEのみ
- **将来**: 反響次第でVitePress等でドキュメントサイト追加

---

## 未決定事項（技術的な設計）

以下は今後の技術設計フェーズで決定する：

- [ ] モノレポの具体的な構成（packages/の分け方）
- [ ] pnpm workspace設定
- [ ] src/内のモジュール設計（ディレクトリ構成）
- [ ] 具体的なAPI設計（メソッド名、引数の型など）
- [ ] テスト戦略の詳細

---

## 決定の経緯（2026-01-11）

### 差別化について
- Q: ExcelJSを直接使わずxlkitを使う理由は？
- A: JS/TypeScriptのExcel出力ライブラリは命令的で最終的なアウトプットがわかりづらい。宣言的でアウトプットがわかりやすい形でプログラマーが書けるようなライブラリを目指したい。

### ユースケースについて
- Q: メインのユースケースは？
- A: データエクスポートがメイン。表だけでなく、表+ちょっとテキストにも対応したい。細かい帳票レベルは不要。

### 動作環境について
- Q: 動作環境はどこを想定？
- A: Node.js + ブラウザ両対応。ExcelJSが両対応なので自然な選択。

### API設計について
- Q: 宣言的なAPIの書き方のイメージは？
- A: メソッドチェーン型。TypeScriptとの相性が良く、補完も効きやすい。

### 機能スコープについて
- 複数シート対応: 必須
- 大規模データ対応（ストリーミング）: v1.0に含める。10万行以上が必要。
- 数式サポート: 不要。計算はプログラム側で行う。
- 既存Excelへの追記: 不要。複雑で需要も限定的。

### スタイリングについて
- Q: スタイリングの柔軟性はどこまで必要？
- A: 両方。プリセットで簡単に、必要なら細かく指定もできる。

### エラーハンドリングについて
- Q: エラー時の挙動は？
- A: 使い分け。デフォルト値で動く場合はデフォルト値で。何も起きない状態は避けたいのでthrow Errorをちゃんとする。

### Excel読み取り機能について
- 主な用途: xlkitの結合テストで生成したファイルが意図どおりか確かめたい
- 読み取り対象: セル値、スタイル、マージ情報、シート名
- 対象外: 列幅・行高

### デモについて
- フロントエンド: シンプルなサンプル集
- バックエンド: examples/にNode.jsサンプルコードを配置。開発者がローカルで実行可能。
