# ワークブックマージ機能実装計画

## 概要

複数の`WorkbookBuilder`インスタンスを1つにマージする`.merge()`メソッドを実装する。

### 目的
- 別々に作成したワークブックを後から統合できるようにする
- モジュール化されたコードで各シートを独立して作成し、最後にまとめられる
- 複数人で分担してシートを作成する場合に便利

### ユースケース
```typescript
// 売上シートと在庫シートを別々に作成
const salesBook = xlkit()
  .sheet("売上")
  .table({ columns: [...], data: salesData });

const stockBook = xlkit()
  .sheet("在庫")
  .table({ columns: [...], data: stockData });

// 最後にマージ
const merged = xlkit().merge([salesBook, stockBook]);
await merged.getNode().saveToFile("report.xlsx");
```

---

## 実装する機能

### `.merge()` メソッド

**シグネチャ:**
```typescript
merge(workbooks: WorkbookBuilder[]): this
```

**動作仕様:**
- 引数で渡された`WorkbookBuilder`の配列内の全シートを、自身のワークブックに追加する
- シート名が重複する場合はエラーをスローする
- 空のワークブック（シートが0個）は無視する
- メソッドチェーンを継続できるよう`this`を返す

---

## 実装詳細

### WorkbookBuilder クラスへのメソッド追加

**ファイル:** `src/core/workbook-builder.ts`

```typescript
/**
 * 複数のワークブックをマージする
 * @param workbooks マージするワークブックの配列
 * @returns this（メソッドチェーン用）
 */
merge(workbooks: WorkbookBuilder[]): this {
  for (const workbook of workbooks) {
    const sourceState = workbook.getState();

    // 空のワークブックは無視
    if (sourceState.sheets.length === 0) {
      continue;
    }

    // 各シートを自身のワークブックに追加
    for (const sheet of sourceState.sheets) {
      // シート名の重複チェック
      if (this.state.sheets.some((s) => s.name === sheet.name)) {
        throw new Error(`Sheet name "${sheet.name}" already exists`);
      }

      // シート名のExcel制約チェック（念のため）
      validateSheetName(sheet.name);

      // シートを追加
      this.state.sheets.push(sheet);
    }
  }

  return this;
}
```

### SheetBuilder クラスへのメソッド追加

**ファイル:** `src/core/sheet-builder.ts`

```typescript
/**
 * 複数のワークブックをマージする（WorkbookBuilderに委譲）
 */
merge(workbooks: WorkbookBuilder[]): WorkbookBuilder {
  return this.workbook.merge(workbooks);
}
```

**戻り値の注意点:**
- `SheetBuilder`から`merge()`を呼んだ場合、`WorkbookBuilder`を返す
- これは既存の`.sheet()`メソッドと同じ動作（SheetBuilderを返す）と異なる
- 理由: マージ後は複数シートの状態になるため、特定のシートに紐づかない

---

## エラーハンドリング

### シート名の重複

```typescript
const bookA = xlkit().sheet("Data").table(...);
const bookB = xlkit().sheet("Data").table(...);

// エラー: Sheet name "Data" already exists
xlkit().merge([bookA, bookB]);
```

### 空のワークブック

```typescript
const empty = xlkit();  // シートが0個
const bookA = xlkit().sheet("A").table(...);

// 正常に動作（emptyは無視される）
xlkit().merge([empty, bookA]);
```

---

## ユニットテスト

**ファイル:** `src/core/workbook-builder.test.ts`

```typescript
describe("WorkbookBuilder.merge()", () => {
  it("複数のワークブックをマージできる", () => {
    const bookA = xlkit().sheet("A").text("A");
    const bookB = xlkit().sheet("B").text("B");
    const merged = xlkit().merge([bookA, bookB]);

    const state = merged.getState();
    expect(state.sheets).toHaveLength(2);
    expect(state.sheets[0].name).toBe("A");
    expect(state.sheets[1].name).toBe("B");
  });

  it("シート名が重複する場合はエラーをスローする", () => {
    const bookA = xlkit().sheet("Sheet1").text("A");
    const bookB = xlkit().sheet("Sheet1").text("B");

    expect(() => {
      xlkit().merge([bookA, bookB]);
    }).toThrow('Sheet name "Sheet1" already exists');
  });

  it("空のワークブックは無視する", () => {
    const empty = xlkit();
    const bookA = xlkit().sheet("A").text("A");
    const merged = xlkit().merge([empty, bookA]);

    const state = merged.getState();
    expect(state.sheets).toHaveLength(1);
    expect(state.sheets[0].name).toBe("A");
  });

  it("マージ元のワークブックに複数シートがある場合も動作する", () => {
    const bookA = xlkit().sheet("A1").text("A1").sheet("A2").text("A2");
    const bookB = xlkit().sheet("B1").text("B1");
    const merged = xlkit().merge([bookA, bookB]);

    const state = merged.getState();
    expect(state.sheets).toHaveLength(3);
    expect(state.sheets[0].name).toBe("A1");
    expect(state.sheets[1].name).toBe("A2");
    expect(state.sheets[2].name).toBe("B1");
  });

  it("メソッドチェーンで使える", () => {
    const bookA = xlkit().sheet("A").text("A");
    const bookB = xlkit().sheet("B").text("B");

    const merged = xlkit()
      .sheet("Start")
      .text("Start")
      .merge([bookA, bookB])
      .sheet("End")
      .text("End");

    const state = merged.getState();
    expect(state.sheets).toHaveLength(4);
    expect(state.sheets.map(s => s.name)).toEqual(["Start", "A", "B", "End"]);
  });

  it("SheetBuilderからmerge()を呼べる", () => {
    const bookA = xlkit().sheet("A").text("A");
    const bookB = xlkit().sheet("B").text("B");

    const merged = xlkit()
      .sheet("Start")
      .text("Start")
      .merge([bookA, bookB]);  // SheetBuilderから呼ぶ

    const state = merged.getState();
    expect(state.sheets).toHaveLength(3);
  });
});
```

---

## 結合テスト

**ファイル:** `tests/integration/10-workbook-merge.test.ts` (新規作成)

```typescript
import { describe, expect, it } from "vitest";
import { xlkit } from "../../src";
import { readWorkbook } from "../../src/reader/workbook-reader";

describe("Workbook merge integration", () => {
  it("マージしたワークブックを正しくExcel出力できる", async () => {
    // 別々にワークブックを作成
    const salesBook = xlkit()
      .sheet("売上")
      .table({
        preset: "basic",
        columns: [
          { key: "product", label: "商品" },
          { key: "amount", label: "売上" },
        ],
        data: [
          { product: "りんご", amount: 1000 },
          { product: "みかん", amount: 800 },
        ],
      });

    const stockBook = xlkit()
      .sheet("在庫")
      .table({
        preset: "basic",
        columns: [
          { key: "product", label: "商品" },
          { key: "stock", label: "在庫数" },
        ],
        data: [
          { product: "りんご", stock: 50 },
          { product: "みかん", stock: 100 },
        ],
      });

    // マージして出力
    const merged = xlkit().merge([salesBook, stockBook]);
    const output = await merged.getNode();
    const buffer = await output.toBuffer();

    // 読み取って検証
    const workbook = await readWorkbook(buffer);

    expect(workbook.sheets).toHaveLength(2);
    expect(workbook.sheets[0].name).toBe("売上");
    expect(workbook.sheets[1].name).toBe("在庫");

    // 売上シートの検証
    const salesSheet = workbook.sheets[0];
    expect(salesSheet.getCell(1, 1).value).toBe("商品");
    expect(salesSheet.getCell(1, 2).value).toBe("売上");
    expect(salesSheet.getCell(2, 1).value).toBe("りんご");
    expect(salesSheet.getCell(2, 2).value).toBe(1000);

    // 在庫シートの検証
    const stockSheet = workbook.sheets[1];
    expect(stockSheet.getCell(1, 1).value).toBe("商品");
    expect(stockSheet.getCell(1, 2).value).toBe("在庫数");
    expect(stockSheet.getCell(2, 1).value).toBe("りんご");
    expect(stockSheet.getCell(2, 2).value).toBe(50);
  });
});
```

---

## 修正対象ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `src/core/workbook-builder.ts` | `.merge()` メソッドを追加 |
| `src/core/workbook-builder.test.ts` | ユニットテストを追加 |
| `src/core/sheet-builder.ts` | `.merge()` メソッドを追加（WorkbookBuilderに委譲） |
| `tests/integration/10-workbook-merge.test.ts` | 結合テストを新規作成 |
| `website/docs/api-reference/xlkit.md` | APIドキュメントに`.merge()`を追加 |
| `website/docs/guides/multi-sheet.md` | マージ機能の使い方を追加 |
| `website/i18n/en/.../api-reference/xlkit.md` | 英語版APIドキュメントに`.merge()`を追加 |
| `website/i18n/en/.../guides/multi-sheet.md` | 英語版ガイドにマージ機能の使い方を追加 |

---

## ドキュメント更新

### API Reference

**ファイル:** `website/docs/api-reference/xlkit.md`

```markdown
## merge()

複数のワークブックを1つにマージします。

```typescript
const bookA = xlkit().sheet("A").table({ ... });
const bookB = xlkit().sheet("B").table({ ... });
const merged = xlkit().merge([bookA, bookB]);
```

**パラメータ:**
- `workbooks: WorkbookBuilder[]` - マージするワークブックの配列

**戻り値:**
- `WorkbookBuilder` または `this`

**エラー:**
- シート名が重複する場合は `Error` をスロー
- 空のワークブック（シートが0個）は無視される

**使用例:**
```typescript
// モジュール化されたシート作成
function createSalesSheet() {
  return xlkit().sheet("売上").table({ ... });
}

function createStockSheet() {
  return xlkit().sheet("在庫").table({ ... });
}

// マージして1つのファイルに
const merged = xlkit().merge([
  createSalesSheet(),
  createStockSheet(),
]);

await merged.getNode().saveToFile("report.xlsx");
```
```

### User Guide

**ファイル:** `website/docs/guides/multi-sheet.md`

既存のドキュメントに以下のセクションを追加:

```markdown
## ワークブックのマージ

別々に作成したワークブックを後からマージできます。

### 基本的な使い方

```typescript
const bookA = xlkit().sheet("A").table({ ... });
const bookB = xlkit().sheet("B").table({ ... });
const merged = xlkit().merge([bookA, bookB]);
```

### ユースケース

#### モジュール化

```typescript
// 各シートを関数で分離
function createSalesSheet() {
  return xlkit()
    .sheet("売上")
    .table({ columns: [...], data: salesData });
}

function createStockSheet() {
  return xlkit()
    .sheet("在庫")
    .table({ columns: [...], data: stockData });
}

// マージして出力
const report = xlkit().merge([
  createSalesSheet(),
  createStockSheet(),
]);
```

#### 条件付きシート追加

```typescript
const baseBook = xlkit().sheet("基本データ").table({ ... });
const sheets = [baseBook];

if (includeDetails) {
  sheets.push(xlkit().sheet("詳細").table({ ... }));
}

if (includeSummary) {
  sheets.push(xlkit().sheet("集計").table({ ... }));
}

const report = xlkit().merge(sheets);
```

### 注意点

- **シート名の重複**: 同じシート名がある場合はエラーになります
- **空のワークブック**: シートが1つもないワークブックは無視されます
```

### English API Reference

**ファイル:** `website/i18n/en/.../api-reference/xlkit.md`

```markdown
## merge()

Merges multiple workbooks into one.

```typescript
const bookA = xlkit().sheet("A").table({ ... });
const bookB = xlkit().sheet("B").table({ ... });
const merged = xlkit().merge([bookA, bookB]);
```

**Parameters:**
- `workbooks: WorkbookBuilder[]` - Array of workbooks to merge

**Returns:**
- `WorkbookBuilder` or `this`

**Errors:**
- Throws `Error` if sheet names are duplicated
- Empty workbooks (0 sheets) are ignored
```

### English User Guide

**ファイル:** `website/i18n/en/.../guides/multi-sheet.md`

既存のドキュメントに以下のセクションを追加:

```markdown
## Merging Workbooks

You can merge separately created workbooks later.

### Basic Usage

```typescript
const bookA = xlkit().sheet("A").table({ ... });
const bookB = xlkit().sheet("B").table({ ... });
const merged = xlkit().merge([bookA, bookB]);
```

### Use Cases

#### Modularization

```typescript
// Separate each sheet into functions
function createSalesSheet() {
  return xlkit()
    .sheet("Sales")
    .table({ columns: [...], data: salesData });
}

function createStockSheet() {
  return xlkit()
    .sheet("Stock")
    .table({ columns: [...], data: stockData });
}

// Merge and output
const report = xlkit().merge([
  createSalesSheet(),
  createStockSheet(),
]);
```

#### Conditional Sheet Addition

```typescript
const baseBook = xlkit().sheet("Base Data").table({ ... });
const sheets = [baseBook];

if (includeDetails) {
  sheets.push(xlkit().sheet("Details").table({ ... }));
}

if (includeSummary) {
  sheets.push(xlkit().sheet("Summary").table({ ... }));
}

const report = xlkit().merge(sheets);
```

### Notes

- **Duplicate sheet names**: An error is thrown if the same sheet name exists
- **Empty workbooks**: Workbooks with no sheets are ignored
```

---

## 検証方法

```bash
# ユニットテスト実行
pnpm test src/core/workbook-builder.test.ts

# 結合テスト実行
pnpm test tests/integration/10-workbook-merge.test.ts

# 全テスト実行
pnpm test

# 型チェック
pnpm type-check

# コード品質チェック
pnpm lint && pnpm format
```

---

## 実装順序

1. ✅ 実装計画ドキュメント作成（このファイル）
2. `WorkbookBuilder.merge()` メソッド実装
3. `SheetBuilder.merge()` メソッド実装
4. ユニットテスト実装
5. テスト実行・修正
6. 結合テスト実装
7. テスト実行・修正
8. ドキュメント更新
9. 最終確認（lint, format, type-check）
