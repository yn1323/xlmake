# ブラウザ「Buffer is not defined」エラー修正計画

## 問題の概要
ブラウザ環境でxlkitを使用すると「Buffer is not defined」エラーが発生する。Node.js固有のグローバル変数`Buffer`がブラウザで未定義のため。

## 原因箇所（3ファイル）

| ファイル | 行 | 問題コード |
|----------|-----|-----------|
| `src/types/image.ts` | 14-15 | `Buffer.isBuffer(source)` |
| `src/engine/sheet-writer.ts` | 400-401 | `Buffer.isBuffer(source)` |
| `src/reader/workbook-reader.ts` | 53 | `Buffer.isBuffer(source)` |

## 修正方針

1. **Buffer参照エラー防止** - `typeof Buffer`チェックを追加
2. **URL fetch対応** - ブラウザでURL指定の画像が使えるようにする
3. **ドキュメント更新** - ブラウザでの使用方法を追記

---

## 修正内容

### 1. ユーティリティ関数の作成
`src/utils/buffer.ts` を新規作成：

```typescript
/**
 * Bufferかどうかを安全に判定（ブラウザ環境でもエラーにならない）
 */
export function isBuffer(value: unknown): value is Buffer {
  return typeof Buffer !== "undefined" && Buffer.isBuffer(value);
}

/**
 * URLかどうかを判定
 */
export function isUrl(value: string): boolean {
  return value.startsWith("http://") || value.startsWith("https://");
}
```

### 2. sheet-writer.ts の画像処理を修正
`src/engine/sheet-writer.ts` の `writeImage()` メソッドを以下のように修正：

```typescript
private async writeImage(options: ImageOptions): Promise<void> {
  const { source, width = 100, height = 100, row, col = 0 } = options;

  let imageBuffer: Buffer | ArrayBuffer;

  if (isBuffer(source)) {
    // Node.js Buffer
    imageBuffer = source;
  } else if (isUrl(source)) {
    // URL - fetch APIで取得（ブラウザ・Node.js両対応）
    const response = await fetch(source);
    imageBuffer = await response.arrayBuffer();
  } else {
    // ファイルパス - Node.jsのみ
    if (typeof window !== "undefined") {
      throw new Error("File path is not supported in browser. Use URL or Buffer.");
    }
    const fs = require("node:fs") as typeof import("node:fs");
    imageBuffer = fs.readFileSync(source);
  }

  // ExcelJSで画像追加
  const imageId = this.workbook.addImage({
    buffer: imageBuffer,
    extension: "png",
  });
  // ...
}
```

**注意**: `writeImage`を非同期にすると、呼び出しチェーン全体の非同期化が必要：
- `writeImage` → `writeBlock` → `writeSheet` → `writer.ts`

ただし、これらは内部メソッドであり、外部APIには影響なし（既に`getNode()`等は`async`）。

### 3. types/image.ts の修正
- `isBuffer()`関数を削除し、`utils/buffer.ts`を使用

### 4. reader/workbook-reader.ts の修正
- `isBuffer()`を`utils/buffer.ts`からimport

### 5. ドキュメント更新

#### website/docs/guides/images.md
ブラウザでの使用方法セクションを追加：

```markdown
## ブラウザでの使用

ブラウザ環境では、URL指定で画像を挿入できます。

\`\`\`typescript
.image({
  source: "https://example.com/logo.png",
  width: 150,
  height: 75,
})
\`\`\`

**注意**: ファイルパス指定はNode.js環境でのみ使用できます。
```

#### website/docs/api-reference/image.md
sourceプロパティの説明を更新：

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| `source` | `Buffer` \| `string` | 画像データ、URL、またはファイルパス（Node.jsのみ） |

---

## 修正対象ファイル一覧

### ソースコード
1. `src/utils/buffer.ts` - 新規作成
2. `src/types/image.ts` - isBuffer削除
3. `src/engine/sheet-writer.ts` - writeImage修正（非同期化+URL fetch対応）
4. `src/reader/workbook-reader.ts` - isBuffer import修正

### ドキュメント（日本語）
5. `website/docs/guides/images.md` - URL指定、ブラウザ使用方法追加
6. `website/docs/api-reference/image.md` - source説明更新

### ドキュメント（英語）
7. `website/i18n/en/.../guides/images.md` - URL指定、ブラウザ使用方法追加
8. `website/i18n/en/.../api-reference/image.md` - source説明更新

### 変更不要
- `README.md` - 画像機能への言及なし
- `docs/spec/all-spec-index.md` - 構造変更なし

### 結合テスト（任意）
- `tests/integration/07-image.test.ts` - URL fetchテスト追加検討

### ランディングページ
9. `website/src/pages/index.js` - サンプルコード更新 + ダウンロードボタン追加

#### 変更内容
- コード例を画像付きサンプルに変更
- 「ダウンロードして試す」ボタンを追加（xlkitを使ってExcelを生成・ダウンロード）

```jsx
// イメージ
function CodeExample() {
  const handleDownload = async () => {
    const { xlkit } = await import("xlkit");
    const output = await xlkit()
      .sheet("サンプル")
      .text({ value: "xlkit サンプル", style: { bold: true, fontSize: 16 } })
      .space(1)
      .image({
        source: "https://raw.githubusercontent.com/yn1323/xlkit/main/logo.png",
        width: 150,
        height: 75,
      })
      .space(2)
      .table({
        preset: "basic",
        columns: [...],
        data: [...],
      })
      .getNode();

    await output.downloadBrowser("sample.xlsx");
  };

  return (
    // ...
    <button onClick={handleDownload}>ダウンロードして試す</button>
  );
}
```

---

### 実装計画ドキュメント
10. `docs/impl/2026-01-12_ブラウザ対応実装計画.md` - 本計画を保存

---

## 検証方法

1. `pnpm type-check` - 型チェック
2. `pnpm lint` - リンティング
3. `pnpm format` - フォーマット
4. `pnpm test` - 既存テストが通ることを確認
5. websiteでブラウザ動作確認
   - 基本的なExcel出力が動作すること
   - URL指定の画像挿入が動作すること（CORSに注意）

---

## 関連ドキュメント

- `docs/spec/2026-01-06_xlkit-design.md` - xlkit設計骨子（動作環境: Node.js + ブラウザ両対応）
- `docs/spec/2026-01-11_xlkit-feature-spec.md` - 機能仕様
