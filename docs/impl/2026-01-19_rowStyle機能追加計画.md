# xlmake _rowStyle機能 実装計画

## 概要

データ行全体にスタイルを一括で適用する `_rowStyle` プロパティを追加する。
また、既存の `style.header` のテストも追加する。

## 背景

xlmakeでは現在、スタイルを以下の方法で適用できる：
- `style.header`: ヘッダー全体
- `style.body`: body全体
- `columns[].style`: 列単位
- `data[]._style`: セル単位

しかし、**特定のデータ行全体にスタイルを適用する方法がない**。
例えば「合計行だけ太字にする」「エラー行だけ背景色を変える」といったユースケースに対応するため、`_rowStyle` を追加する。

## 参考ドキュメント

- [機能仕様書](../spec/2026-01-11_xlmake-feature-spec.md) - スタイル関連の仕様
- [API設計書](../spec/2026-01-11_xlmake-api-design.md) - 既存のスタイルAPI
- [テスト計画](./2026-01-11_integration-test-plan.md) - テストケース詳細

---

## API仕様（ユーザー視点）

### `_rowStyle` の使い方

```typescript
xlmake()
  .sheet("売上")
  .table({
    columns: [
      { key: "name", label: "商品名" },
      { key: "price", label: "価格" },
    ],
    data: [
      { name: "りんご", price: 100 },
      { name: "みかん", price: 80 },
      { name: "合計", price: 180, _rowStyle: { bold: true, fill: "#FFFF00" } },  // ← この行全体に適用
    ],
  })
  .getNode();
```

### スタイル優先順位（低→高）

```
プリセット → ストライプ → 列スタイル → テーブルスタイル(body) → _rowStyle → _style
```

| 優先度 | スタイル | 適用範囲 |
|-------|---------|---------|
| 1（低）| プリセット（`preset`） | テーブル全体 |
| 2 | ストライプ（`stripedRowColor`） | 奇数行 |
| 3 | 列スタイル（`columns[].style`） | 特定の列 |
| 4 | テーブルスタイル（`style.body`） | body全体 |
| 5 | **行スタイル（`_rowStyle`）** | **特定の行** ← 新規追加 |
| 6（高）| セルスタイル（`_style`） | 特定のセル |

### 縦マージセルの扱い

**決定:** 行ごとに独立して適用（シンプル）

マージされたセルがある場合、各行の `_rowStyle` はその行のセルに独立して適用される。
マージセル全体に統一したスタイルを適用したい場合は、マージされる各行に同じ `_rowStyle` を指定する。

```typescript
data: [
  { category: "A", name: "太郎", _rowStyle: { fill: "#FFCCCC" } },
  { category: "A", name: "花子", _rowStyle: { fill: "#FFCCCC" } },  // categoryがマージされる
  { category: "B", name: "次郎" },
]
```

---

## 現状分析

| 機能 | 仕様 | 型定義 | 実装 | テスト |
|------|------|--------|------|--------|
| `style.header` | 定義済み | 定義済み（TableStyle） | 実装済み | **なし** |
| `style.body` | 定義済み | 定義済み（TableStyle） | 実装済み | **なし** |
| `_style`（セル単位） | 定義済み | 定義済み | 実装済み | あり |
| `_rowStyle`（行単位） | **なし** | **なし** | **なし** | **なし** |

### 現状のコード

**スタイル適用箇所**: `src/engine/sheet-writer.ts` 224-235行目

```typescript
// 現在のスタイルカスケーディング
const baseStyle = presetConfig?.style?.body;
const columnStyle = col.style;
const rowStyle = tableStyle?.body;
const cellStyle = rowData._style?.[col.key];

const finalStyle = mergeStyles(baseStyle, stripeStyle, columnStyle, rowStyle, cellStyle);
```

**変更後:**
```typescript
const baseStyle = presetConfig?.style?.body;
const columnStyle = col.style;
const rowStyle = tableStyle?.body;
const rowRowStyle = rowData._rowStyle;  // ← 追加
const cellStyle = rowData._style?.[col.key];

const finalStyle = mergeStyles(baseStyle, stripeStyle, columnStyle, rowStyle, rowRowStyle, cellStyle);
```

---

## 実装フェーズ

### Phase 1: 型定義の拡張

**ファイル**: `src/types/table.ts`

**変更内容** (19行目付近):
```typescript
// 変更前
data: (T & { _style?: Partial<Record<keyof T, CellStyle>> })[];

// 変更後
data: (T & {
  _style?: Partial<Record<keyof T, CellStyle>>;
  _rowStyle?: CellStyle;
})[];
```

---

### Phase 2: スタイル適用ロジックの実装

**ファイル**: `src/engine/sheet-writer.ts`

**変更箇所1: シグネチャ (196行目付近)**
```typescript
data: (T & {
  _style?: Partial<Record<keyof T, CellStyle>>;
  _rowStyle?: CellStyle;
})[],
```

**変更箇所2: スタイルマージ (228行目付近)**
```typescript
const rowRowStyle = rowData._rowStyle;  // 追加
```

**変更箇所3: mergeStyles呼び出し (235行目)**
```typescript
const finalStyle = mergeStyles(baseStyle, stripeStyle, columnStyle, rowStyle, rowRowStyle, cellStyle);
```

---

### Phase 3: テストの作成

**新規ファイル**: `tests/integration/09-row-styles.test.ts`

**シート構成（6シート）**:

| シート名 | 内容 |
|---------|------|
| RowStyleBasic | `_rowStyle` の基本動作（行全体に背景色） |
| RowStylePriority | `_rowStyle` と `_style` の優先順位 |
| RowStyleWithColumn | `_rowStyle` と列スタイルの優先順位 |
| RowStyleWithStripe | `_rowStyle` とストライプの優先順位 |
| HeaderStyle | `style.header` の動作確認 |
| HeaderStyleWithColumn | `style.header` と列スタイルの優先順位 |

**検証項目**:
- `_rowStyle` が行全体に適用されること
- スタイル優先順位が正しいこと
- `style.header` が全ヘッダー行に適用されること

---

### Phase 4: ドキュメント更新（日本語）

| ファイル | 変更内容 |
|---------|---------|
| `website/docs/guides/styling.md` | 「行スタイル（_rowStyle）」セクションを追加 |
| `website/docs/api-reference/styling.md` | スタイル優先順位に `_rowStyle` を追加 |
| `website/docs/api-reference/table.md` | dataの説明に `_rowStyle` を追加 |
| `website/docs/examples/conditional-styling.md` | `_rowStyle` の例を追加、優先順位を更新 |

---

### Phase 5: ドキュメント更新（英語）

| ファイル | 変更内容 |
|---------|---------|
| `website/i18n/en/.../guides/styling.md` | 「Row Style (_rowStyle)」セクションを追加 |
| `website/i18n/en/.../api-reference/styling.md` | スタイル優先順位に `_rowStyle` を追加 |
| `website/i18n/en/.../api-reference/table.md` | dataの説明に `_rowStyle` を追加 |
| `website/i18n/en/.../examples/conditional-styling.md` | `_rowStyle` の例を追加 |

---

### Phase 6: 品質チェック

```bash
pnpm format
pnpm lint
pnpm type-check
pnpm test
```

---

## 修正対象ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `src/types/table.ts` | 型定義に `_rowStyle?: CellStyle` を追加 |
| `src/engine/sheet-writer.ts` | スタイル適用ロジックに `_rowStyle` を組み込み |
| `tests/integration/09-row-styles.test.ts` | 新規作成 |
| `website/docs/guides/styling.md` | 日本語ドキュメント更新 |
| `website/docs/api-reference/styling.md` | 日本語ドキュメント更新 |
| `website/docs/api-reference/table.md` | 日本語ドキュメント更新 |
| `website/docs/examples/conditional-styling.md` | 日本語ドキュメント更新 |
| `website/i18n/en/.../guides/styling.md` | 英語ドキュメント更新 |
| `website/i18n/en/.../api-reference/styling.md` | 英語ドキュメント更新 |
| `website/i18n/en/.../api-reference/table.md` | 英語ドキュメント更新 |
| `website/i18n/en/.../examples/conditional-styling.md` | 英語ドキュメント更新 |

---

## 検証方法

```bash
# 型チェック
pnpm type-check

# リント・フォーマット
pnpm lint && pnpm format

# テスト実行
pnpm test

# 出力ファイル確認
# tests/output/09-row-styles.xlsx を Excel で開いて目視確認
```

---

## 注意点・考慮事項

### `_rowStyle` vs `_style` の型の違い

| プロパティ | 型 | 理由 |
|-----------|---|------|
| `_style` | `Partial<Record<keyof T, CellStyle>>` | 列（key）ごとにスタイルを指定 |
| `_rowStyle` | `CellStyle` | 行全体に同じスタイルを適用 |

### 変更不要なファイル

- `src/styles/merger.ts` - 既に可変長引数に対応済み
- `src/types/style.ts` - CellStyle型は変更不要
- `README.md` - 簡単な例のみなので変更不要
- `docs/spec/all-spec-index.md` - インデックスのみなので変更不要

---

## 決定の経緯（2026-01-19）

### API形式の選択
- Q: 行スタイルのAPIはどうするか？
- A: `_rowStyle` プロパティ。既存の `_style` パターンを踏襲し、一貫性を保つ。

### 縦マージセルの扱い
- Q: 縦マージセルでの `_rowStyle` の扱いは？
- A: 行ごとに独立して適用（シンプル実装）。マージ全体に適用したい場合は各行に同じスタイルを指定。

### ヘッダーの行スタイル
- Q: ヘッダー行にも同様の機能が必要か？
- A: 不要。既存の `style.header` で対応可能。
