# xlkit マージ機能 実装計画

## 概要

xlkitのマージ機能（ヘッダーマージ + ボディマージ）を実装し、09-merge.test.ts として結合テストを作成する。

## 背景

xlkitは宣言的なExcel生成ライブラリ。マージ機能の仕様は設計ドキュメントで定義済みだが、実装がまだできていない状態。

## 参考ドキュメント

- [機能仕様書](../spec/2026-01-11_xlkit-feature-spec.md) - 3.1 テーブルブロック（ヘッダー、ボディの項）
- [API設計書](../spec/2026-01-11_xlkit-api-design.md) - 3.1 テーブルブロック（columnsの定義、ボディの自動マージ）
- [テスト計画](./2026-01-11_integration-test-plan.md) - テストケース詳細
- [API実装計画](./2026-01-11_xlkit-api-implementation-plan.md) - 実装の全体像

---

## 現状分析

| 機能 | 仕様 | 型定義 | 実装 |
|------|------|--------|------|
| マルチヘッダー | 定義済み | 定義済み（ParentColumn, LeafColumn） | 未実装（エラーを投げる） |
| mergeSameValues | 定義済み | 定義済み（column.ts, table.ts） | 未実装（処理なし） |
| mergeCells API | - | - | 実装済み（cell-writer.ts） |
| mergedCells 読み取り | - | - | 実装済み（sheet-reader.ts） |

### 現状のコード

**マルチヘッダー**: `src/engine/sheet-writer.ts` の `writeHeaders()` でマルチヘッダーを指定すると例外を投げる
```typescript
} else {
  // マルチヘッダーは後で実装
  throw new Error("マルチヘッダーは未実装です");
}
```

**mergeSameValues**: 型定義とスキーマはあるが、`writeDataRows()` に実際のマージ処理がない

---

## API仕様（ユーザー視点）

### ボディのマージ（mergeSameValues）

**テーブル全体で有効にする場合:**
```typescript
.table({
  mergeSameValues: true,  // 全列でマージ有効
  columns: [
    { key: "category", label: "カテゴリ" },
    { key: "name", label: "商品名" },
  ],
  data: [
    { category: "食品", name: "りんご" },
    { category: "食品", name: "みかん" },  // ← 食品がマージされる
    { category: "家電", name: "テレビ" },
  ],
})
```

**列単位で有効にする場合:**
```typescript
.table({
  columns: [
    { key: "category", label: "カテゴリ", mergeSameValues: true },  // ← この列だけマージ
    { key: "name", label: "商品名" },
  ],
  data: [...],
})
```

**優先度:**
| テーブル設定 | 列設定 | 結果 |
|-------------|--------|------|
| あり | あり | すべての列でマージ |
| あり | なし | すべての列でマージ |
| なし | あり | 指定の列のみマージ |
| なし | なし | マージしない |

### マルチヘッダー（children）

```typescript
.table({
  columns: [
    {
      label: "商品情報",  // ← 親ヘッダー（水平マージ）
      children: [
        { key: "category", label: "カテゴリ" },
        { key: "name", label: "商品名" },
      ],
    },
    { key: "price", label: "価格" },  // ← 親なし（垂直マージ）
  ],
  data: [...],
})
```

**出力イメージ:**
```
┌─────────────────┬───────┐
│    商品情報      │ 価格  │  ← 「商品情報」は colSpan=2, 「価格」は rowSpan=2
├────────┬────────┤       │
│カテゴリ│ 商品名 │       │
├────────┼────────┼───────┤
│  食品  │ りんご │  100  │
└────────┴────────┴───────┘
```

---

## 実装フェーズ

### Phase 1: ユーティリティ関数の追加

**ファイル**: `src/utils/column.ts`

追加する関数:
1. `getColumnSpan<T>(column: Column<T>): number` - カラムの水平スパン（リーフ数）を計算
2. `buildHeaderRows<T>(columns: Column<T>[], depth: number): HeaderCell[][]` - ヘッダー行ごとのセル情報を構築

```typescript
type HeaderCell = {
  label: string;
  colSpan: number;  // 水平マージ
  rowSpan: number;  // 垂直マージ
  style?: CellStyle;
};
```

**ユニットテスト**: `src/utils/column.test.ts` に追加

---

### Phase 2: マルチヘッダー書き込みの実装

**ファイル**: `src/engine/sheet-writer.ts`

修正箇所: `writeHeaders()` メソッド

**アルゴリズム**:
1. `buildHeaderRows()` でヘッダー行を構築
2. 各ヘッダー行をループで処理
3. 各セルについて:
   - ラベルを書き込む
   - `colSpan > 1` または `rowSpan > 1` の場合、`mergeCells()` を呼び出す
   - スタイルと罫線を適用

---

### Phase 3: ボディマージ（mergeSameValues）の実装

**ファイル**: `src/engine/sheet-writer.ts`

修正箇所: `writeDataRows()` メソッド

**アルゴリズム**:
1. 各列について `mergeSameValues` が有効かどうかを判定（テーブル全体設定 OR 列設定）
2. マージ対象列について、連続する同じ値のセル範囲を特定
3. データ書き込み後、特定した範囲に対して `mergeCells()` を呼び出す

---

### Phase 4: writeTable メソッドの修正

**ファイル**: `src/engine/sheet-writer.ts`

`writeTable()` から `writeDataRows()` への `mergeSameValues` パラメータ渡しを追加。

---

### Phase 5: テストの作成

**新規ファイル**: `tests/integration/09-merge.test.ts`

**シート構成（6シート）**:

| シート名 | 内容 |
|---------|------|
| MergeSameValues | ボディの垂直マージ（テーブル全体設定） |
| ColumnMergeSameValues | 列単位のマージ設定 |
| MultiHeader | マルチヘッダー（2階層） |
| DeepMultiHeader | マルチヘッダー（3階層） |
| MergeWithBorder | ボディマージ + ボーダー設定の組み合わせ |
| MultiHeaderWithBorder | マルチヘッダー + ボーダー設定の組み合わせ |

**検証項目**:
- `mergedCells` で正しいマージ範囲が取得できること
- マージされたセルの罫線が正しく描画されること（目視確認）
- 目視確認用にファイル出力

**ボーダー組み合わせテストの観点**:
- マージされたセルの外枠に罫線が正しく適用されるか
- ヘッダーとボディの境目（headerBody）がマージセルで正しく表示されるか
- 内部罫線（bodyInner）がマージされた範囲では描画されないか

---

### Phase 6: 既存テストの整理

**ファイル**: `tests/integration/05-table-features.test.ts`

**対応**:
- `MergeSameValues` シートを削除（09-merge.test.ts に移動）
- `MultiHeader` 関連のコメントを削除

---

## 修正対象ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `src/utils/column.ts` | `getColumnSpan()`, `buildHeaderRows()` 関数を追加 |
| `src/utils/column.test.ts` | ユニットテスト追加 |
| `src/engine/sheet-writer.ts` | `writeHeaders()` のマルチヘッダー実装、`writeDataRows()` の mergeSameValues 実装 |
| `tests/integration/09-merge.test.ts` | 新規作成 |
| `tests/integration/05-table-features.test.ts` | MergeSameValues シートを削除 |

---

## 検証方法

```bash
# 型チェック
pnpm type-check

# リント・フォーマット
pnpm lint && pnpm format

# テスト実行
pnpm test

# 出力ファイル確認
# tests/output/09-merge.xlsx を Excel で開いて目視確認
```

---

## 注意点・考慮事項

### 罫線とマージの組み合わせ
- マージされたセルの罫線は、マージ範囲の外枠に適用される
- ExcelJSでは、マージ後に罫線を設定する必要がある場合がある
- 実装時に動作確認が必要

### ストリーミングの制約
- ExcelJSの`WorkbookWriter`では書き込み後に戻って修正ができない
- マージ範囲の収集は書き込みと同時に行い、最後にまとめてマージを実行

### スタイルのカスケーディング
- マージされたセルのスタイルは、左上のセルに適用される
- マルチヘッダーでは各セルに独立したスタイルを適用可能

---

## 決定の経緯（2026-01-12）

### テストブックの分離
- Q: マージ関連のテストは05-table-features.test.tsに含めるか、別ブックにするか？
- A: 09-merge.test.ts として新しいブックを作成する。マージ機能は複雑なため、独立したテストファイルで管理する方が保守しやすい。

### ボーダーとの組み合わせテスト
- Q: ボーダーとマージの組み合わせはテストすべきか？
- A: 必須。マージセルの罫線描画は複雑なため、MergeWithBorderとMultiHeaderWithBorderシートを追加してテストする。